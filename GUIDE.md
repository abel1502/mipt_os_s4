# Зависимости
Во-первых, вам понадобится кросс-компилятор, чтобы собирать ядро. На OSDev Wiki есть [отличный гайд](https://wiki.osdev.org/GCC_Cross-Compiler) как его поставить.

Также для запуска потребуются утилиты, которые собирают загружаемый образ диска. Если вы работаете под Ubuntu:
```
apt-get install grub-common grub-pc-bin xorriso
```
Для macOS инструкцию можно найти [здесь](https://wiki.osdev.org/GRUB_2#Installing_GRUB2_on_Mac_OS_X).

# Сборка и запуск ядра
После установки, кросс-компилятор должен быть доступен у вас как команда `x86_64-elf-gcc`. Если он лежит не в `$PATH`, то нужно его либо туда добавить, либо указать пути до компилятора:
```
export CC=/path/to/x86_64-elf-gcc
export LD=/path/to/x86_64-elf-gcc
export AS=/path/to/x86_64-elf-gcc
```

Дальше всё просто: запускаете `make`, после этого у вас появляются два важных файла:
* `kernel.bin` — ELF-файл ядра
* `kernel.iso` — загружаемый образ ядра вместе с GRUB.

Если нужно удалить все бинарные файлы, возникшие во время сборки: `make clean`.

Для запуска рекомендуется использовать QEMU. Базовый запуск ядра (без диска) выглядит вот так:
```
qemu-system-x86_64 -monitor stdio -cdrom kernel.iso
```

# QEMU cheat sheat
## Запуск с отладчиком
Добавляете флажки `-s` (запускает gdb-server) и `-S` (процессор начнёт исполнять инструкции после того, как подключится отладчик). Например:
```
qemu-system-x86_64 -monitor stdio -cdrom kernel.iso -s -S
```
Затем запускаете gdb. Чтобы подключиться к QEMU:
```
(gdb) target remote :1234
Remote debugging using :1234
warning: No executable has been specified and target does not support
determining executable automatically.  Try using the "file" command.
0x000000000000fff0 in ?? ()
(gdb) symbol-file kernel.bin
Reading symbols from kernel.bin...
```
Дальше у вас есть привычный GDB :). [Документация](https://sourceware.org/gdb/onlinedocs/gdb/index.html).

Полезные команды и хаки:
* `b _start` — брейкпоинт на функцию.
* `b kernel.c:23` — брейкпоинт на строчку в файле.
* `b 53` — брейкпоинт на строчку в текущем файле.
* `la src`/`la asm`/`la regs` — различные варианты окошек.
* `foc cmd`/`foc asm`/`foc src` — переключает фокус на разные окошки.
* `si` — выполнить одну инструкцию и остановиться. Полезна, когда отлаживаете ассемблерный код.
* `s` — выполнить одну строчку из файла.
* `p` — может выводить различные выражения (но не всегда все).
* `p *(struct multiboot_mmap_entry*)0x10000` — посмотреть на структуру `multiboot_mmap_entry`, которая лежит по адресу `0x10000`.
* `x` — встроенный hexdump. Прочитать про него [тут](https://sourceware.org/gdb/onlinedocs/gdb/Memory.html).


## Monitor
Если вы запустили QEMU с параметром `-monito stdio`, то появится вот такой промпт:
```
QEMU 4.2.1 monitor - type 'help' for more information
(qemu)
```

### info mem
Показывает текущие маппинги виртуальной памяти.
```
(qemu) info mem
0000000000000000-0000000040000000 0000000040000000 -r-
начало-конец размер флажки
```

### info registers
Показывает текущее состояние регистров процессора.
```
(qemu) info registers
RAX=0000000000000000 RBX=0000000000102488 RCX=000000000020212f RDX=0000000000000019
RSI=0000000000000007 RDI=0000000000205fd0 RBP=0000000000000000 RSP=0000000000206000
R8 =0000000000000000 R9 =0000000000000000 R10=0000000000000000 R11=0000000000000000
R12=0000000000000000 R13=0000000000000000 R14=0000000000000000 R15=0000000000000000
RIP=0000000000201064 RFL=00000046 [---Z-P-] CPL=0 II=0 A20=1 SMM=0 HLT=1

# Эта секция относится к сегментам
   segment selector       base        limit    flags         type
ES     =0018        0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
CS     =0008        0000000000000000 ffffffff 00af9a00 DPL=0 CS64 [-R-]
SS     =0018        0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
DS     =0018        0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
FS     =0018        0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]
GS     =0018        0000000000000000 ffffffff 00cf9300 DPL=0 DS   [-WA]

# Информация про текущие LDT, GDT, IDT и TSS:
LDT=0000 0000000000000000 0000ffff 00008200 DPL=0 LDT
TR =0000 0000000000000000 0000ffff 00008b00 DPL=0 TSS64-busy
GDT=     0000000000203000 00000010
IDT=     0000000000000000 00000000

# Control registers:
CR0=80000011 CR2=0000000000000000 CR3=0000000000204000 CR4=00000020

# Debug registers:
DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000
DR6=00000000ffff0ff0 DR7=0000000000000400

# IA32_EFER MSR:
EFER=0000000000000500

# Состояние FPU:
FCW=037f FSW=0000 [ST=0] FTW=00 MXCSR=00001f80
FPR0=0000000000000000 0000 FPR1=0000000000000000 0000
FPR2=0000000000000000 0000 FPR3=0000000000000000 0000
FPR4=0000000000000000 0000 FPR5=0000000000000000 0000
FPR6=0000000000000000 0000 FPR7=0000000000000000 0000
XMM00=00000000000000000000000000000000 XMM01=00000000000000000000000000000000
XMM02=00000000000000000000000000000000 XMM03=00000000000000000000000000000000
XMM04=00000000000000000000000000000000 XMM05=00000000000000000000000000000000
XMM06=00000000000000000000000000000000 XMM07=00000000000000000000000000000000
XMM08=00000000000000000000000000000000 XMM09=00000000000000000000000000000000
XMM10=00000000000000000000000000000000 XMM11=00000000000000000000000000000000
XMM12=00000000000000000000000000000000 XMM13=00000000000000000000000000000000
XMM14=00000000000000000000000000000000 XMM15=00000000000000000000000000000000
```
