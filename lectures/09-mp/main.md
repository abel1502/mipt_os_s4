---
marp: true
paginate: true
---

<style>
img[alt~="center"] {
  display: block;
  margin: 0 auto;
}
</style>

# –ú—É–ª—å—Ç–∏–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ—Å—Ç—å

---

# –ö—ç—à –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã —Å–æ—Å—Ç–æ—è—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —è–¥–µ—Ä
* –ö–∞–∂–¥–æ–µ —è–¥—Ä–æ (–æ–±—ã—á–Ω–æ) –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π L1 –∏ L2 –∫—ç—à
* –ï–¥–∏–Ω—ã–π L3 –∫—ç—à –Ω–∞ –≤—Å–µ —è–¥—Ä–∞
* –ß—Ç–µ–Ω–∏–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–æ–ª—å—à–∏–º–∏ –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—ã–º–∏ –∫—É—Å–æ—á–∫–∞–º–∏ ‚Äî –∫—ç—à –ª–∏–Ω–∏—è–º–∏ (cache line)
* –†–∞–∑–º–µ—Ä –∫—ç—à-–ª–∏–Ω–∏–∏ –æ–±—ã—á–Ω–æ 64 –±–∞–π—Ç–∞

---

# –ö–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫—ç—à–µ–π
* –ú–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤—Å–µ—Ö L1/L2 –∫—ç—à–∞—Ö
* –ü—Ä–æ—Ç–æ–∫–æ–ª—ã –∫–æ–≥–µ–Ω–µ—Ä–Ω—Ç–Ω–æ—Å—Ç–∏ –∫—ç—à–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, MOESI)

---

# –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ x86

---

# –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ x86
* –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–æ, –∫–∞–∫ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –Ω–∞ –æ–¥–Ω–æ–º —è–¥—Ä–µ –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —è–¥—Ä–∞—Ö
* => –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —è–¥–µ—Ä :)

---
# –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ x86: –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
–°–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –∞—Ç–æ–º–∞—Ä–Ω—ã:
1. –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –±–∞–π—Ç–∞
1. –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω–æ–≥–æ word (16 –±–∏—Ç)
1. –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω–æ–≥–æ double word (32 –±–∏—Ç–∞)
1. –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω–æ–≥–æ quad word (64 –±–∏—Ç–∞)
1. –ß—Ç–µ–Ω–∏–µ –Ω–µ–≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—ã—Ö word/dword/qword –ø–æ–º–µ—â–∞—é—â–∏—Ö—Å—è –≤ –æ–¥–Ω—É –∫—ç—à-–ª–∏–Ω–∏—é

---

# –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ x86: lock prefix
* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π *–ø—Ä–µ—Ñ–∏–∫—Å* –∫–æ–º–∞–Ω–¥
* –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ write –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö, –∏–Ω–∞—á–µ `#UD`
* ¬´–°–ø–∏–Ω–ª–æ–∫¬ª –¥–ª—è —è–¥–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –Ω–∞ —Ä–µ–≥–∏–æ–Ω –ø–∞–º—è—Ç–∏

---

# –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ x86: orderings
* ISDM, Volume 3A, 8.2


---
# –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ x86: memory barriers
* SFENCE ‚Äî store barrier
* LFENCE ‚Äî load barrier
* MFENCE ‚Äî full memory barrier
* [SFENCE + LFENCE != MFENCE](https://stackoverflow.com/questions/27627969/why-is-or-isnt-sfence-lfence-equivalent-to-mfence)

---

# –ú–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏ x86: serializing instructions
* `lgdt`, `lidt`, `mov crX`, `wrmsr`, etc
* –ù–µ —Ç–æ–ª—å–∫–æ —è–≤–ª—è—é—Ç—Å—è –±–∞—Ä—å–µ—Ä–∞–º–∏ –ø–∞–º—è—Ç–∏, –Ω–æ –∏ –∂–¥—É—Ç –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è out-of-order –¥–µ–π—Å—Ç–≤–∏–π

---

# MP boot protocol

---
# MP boot protocol
* ISDM, Volume 3A, 8.4
* BSP = bootstrap processor, —Ö–∞—Ä–¥–≤–∞—Ä–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, –û–° –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –Ω—ë–º
* AP = application processor, –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã, –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞ –û–° –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º —Å–ø—è—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
* –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —è–¥—Ä–∞—Ö –≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é ACPI —Ç–∞–±–ª–∏—Ü—ã MADT

---
# MP boot protocol
* –ß—Ç–æ–±—ã AP –Ω–∞—á–∞–ª –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–¥, –µ–º—É –Ω—É–∂–Ω–æ –ø–æ—Å–ª–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ APIC: initialization IPI (INIT) –∏ startup IPI (SIPI)
* SIPI —Å–æ–¥–µ—Ä–∂–∏—Ç –≤ —Å–µ–±–µ –∞–¥—Ä–µ—Å, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É AP –Ω–∞—á–Ω—ë—Ç –∏—Å–ø–æ–ª–Ω—è—Ç—å—Å—è
* –ü—Ä–æ–±–ª–µ–º–∞: AP –Ω–∞—á–∏–Ω–∞–µ—Ç –∏—Å–ø–æ–ª–Ω—è—Ç—å—Å—è –∞–∂ –≤ *real mode* (16-–±–∏—Ç–Ω—ã–π —Ä–µ–∂–∏–º)
* AP trampoline ‚Äì –∫—É—Å–æ—á–µ–∫ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥–∏—Ç AP –≤ 64-–±–∏—Ç–Ω—ã–π —Ä–µ–∂–∏–º
* –î–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö AP –∏–ª–∏ –±—Ä–æ–¥–∫–∞—Å—Ç SIPI

---

# Intel Hyper-threading
* Simultaneous multithreading (SMT)
* –ü–æ –¥–≤–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —è–¥—Ä–∞ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ
* –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –º–æ–∂–µ—Ç *–ø—Ä–æ—Å—Ç–∞–∏–≤–∞—Ç—å* (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —á—Ç–µ–Ω–∏—è—Ö –ø–∞–º—è—Ç–∏), –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –Ω–∞ —Å–æ—Å–µ–¥–Ω–µ–º –ª–æ–≥–∏—á–µ—Å–∫–æ–º —è–¥—Ä–µ

---


# RCU
* Read-copy-update
* –ú–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
* –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤ –ª—é–±–æ–π —Å—Ä–µ–¥–µ, –æ–¥–Ω–∞–∫–æ –∏–∑-–∑–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏ –û–° –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ

---

# RCU
* –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Å–∫–æ–ø–∏—Ä–æ–≤–∞–≤ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–∞—Ä–æ–π, –∏–∑–º–µ–Ω–∏—Ç—å –Ω–æ–≤—É—é
* –ò–∑–º–µ–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
* –î–æ–∂–¥–∞—Ç—å—Å—è, –∫–æ–≥–¥–∞ –≤—Å–µ —á–∏—Ç–∞—Ç–µ–ª–∏ —Å—Ç–∞—Ä–æ–π —Å—Ç—É–∫—Ç—É—Ä—ã –∑–∞–∫–æ–Ω—á–∞—Ç —Ä–∞–±–æ—Ç—É —Å –Ω–µ–π
* –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

---

```c
void reader() {
    rcu_read_lock();
    struct_t* s = load_ptr();
    // ...
    rcu_read_unlock();
}
```

```c
void writer() {
    struct_t* old = load_ptr();
    struct_t new = struct_from_old(old);
    store_ptr(new);
    synchronize_rcu();
}
```

---

# RCU
–ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `rcu_read_lock`/`rcu_read_unlock`/`synchronize_rcu`?

---

# RCU: ü™Ñü™Ñü™Ñü™Ñ
```c
void rcu_read_lock(void) { }

void rcu_read_unlock(void) { }

void synchronize_rcu(void) {
    for_each_possible_cpu(cpu) {
        run_on(cpu);
    }
}
```

---

# RCU: ü™Ñü™Ñü™Ñü™Ñ
* –Ø–¥—Ä–æ –∑–∞–ø—Ä–µ—â–∞–µ—Ç –ª—é–±—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ rcu_read_lock/rcu_read_unlock
* => –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–ª—É—á–∏–ª–æ—Å—å, —Ç–æ —è–¥—Ä–æ –≤—ã—à–ª–æ –∏–∑ read-—Å–µ–∫—Ü–∏–∏
* => –µ—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–±—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞—Ö, –º—ã –≤—ã–π–¥–µ–º –∏–∑ –≤—Å–µ—Ö read-—Å–µ–∫—Ü–∏–π
* [–ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ RCU](https://www.kernel.org/doc/html/latest/RCU/whatisRCU.html)

---

# Per-cpu –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
* –ê–Ω–∞–ª–æ–≥ thread-local storage, –Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è–¥—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
* –ü–æ–º–µ—â–∞—é—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é (`.percpu`)
* `#define PER_CPU(name) (GS + (&name - &_percpu_start))`
* –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—á–µ—Ä–µ–¥–Ω–æ–≥–æ CPU, –ø–æ–¥ —Å–µ–∫—Ü–∏—é –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –ø–∞–º—è—Ç—å –∏ –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç—É–¥–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è
* GS/FS –≤ 64-bit mode –Ω–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –≤ GDT, –∞ –ø—Ä–æ—Å—Ç–æ —Å–æ–¥–µ—Ä–∂–∞—Ç –±–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å
* `swapgs` –º–µ–Ω—è–µ—Ç –º–µ—Å—Ç–∞–º–∏ `GS` –∏ `IA32_KERNEL_GS_BASE`
